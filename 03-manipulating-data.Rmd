# Transforming Data

```{r include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
library(tidyverse)
```

## `{dplyr}` basics {-}

The book [R for Data Science](https://r4ds.had.co.nz/) is a *very* helpful reference guide. [Chapter 5](https://r4ds.had.co.nz/transform.html) covers many of the topics covered in this section, and may be useful as a resource later or to dive deeper into a topic. 

Topics:

- Filter rows
  - Comparisons
  - Logical operators
  - Missing values
- Arrange rows
- Select columns
- Add new variables 
- Grouped summaries
  - Combining multiple operations with the pipe
  - Missing values
  - Counts
  - Useful summary functions
  - Grouping by multiple variables
  - Ungrouping
- Grouped mutates (and filters)
- Extra: Working with factor variables


<!--
## Filter rows

- Comparisons
- Logical operators
- Missing values


## Arrange rows

## Select columns

## Add new variables 


##  Grouped summaries

- Combining multiple operations with the pipe
- Missing values
- Counts
- Useful summary functions
- Grouping by multiple variables
- Ungrouping


## Grouped mutates (and filters)



-->









## An example

The following example ties several of the above ideas together. Imagine that we have a set of grades from a course that we would like to convert to letter grades using a particular weighting and letter-grade cut-offs.

```{r}
students <- readr::read_table("data/CourseData.txt")[, -1]
head(students)
tail(students)
```

In this particular case we want the weighting to be:

- 20% to Hmwk (col 3)
- 25% to E1 (col 4)
- 25% to E2 (col 5)
- 30% to E3 (col 6)

But those weights could change later. A function can be written to take the data, and the weights and calculate the weighted average. We can then add that score to the students data frame, and add a final column with the actual letter grades on a 90-80-70-60 scale.

```{r}
students <- students %>% 
  mutate(Final = .2*Hmwk + .25*E1 + .25*E2 + .3*E3,
         Grade = case_when(
           Final < 60 ~ "F",
           Final < 69 ~ "D",
           Final < 79 ~ "C",
           Final < 89 ~ "B",
           Final >= 90 ~ "A"))

head(students)
```


<!-- ## Extra: Working with factor variables -->





# Reshaping Data

## `{tidyr}` basics {-}

The book [R for Data Science](https://r4ds.had.co.nz/) is a *very* helpful reference guide. [Chapter 12](https://r4ds.had.co.nz/tidy-data.html) covers many of the topics covered in this section, and may be useful as a resource later or to dive deeper into a topic. 

Topics:

- Tidy data
- Pivoting
  - Longer
  - Wider
- Separate & unite



## An example

Reshape data into long form:

```{r}
## load data
library(psych)
data(bfi)
bfi_trim <- bfi %>% 
  dplyr::select(matches('^A[1-5]|^N'))

## Compare the 1 to 3 factor solutions
model1 = fa(bfi_trim, 1)
model2 = fa(bfi_trim, 2)
model3 = fa(bfi_trim, 3)

## as a matrix
obs = cor(bfi_trim, use = "pairwise.complete.obs") 
obs
```


```{r}
## in long form
obs_long <- obs %>% 
  as_tibble() %>% 
  mutate(i = names(.)) %>% 
  pivot_longer(cols = -i, names_to = "j", values_to = "obs")
obs_long

## add model residuals
fa_models <- obs_long %>% 
  mutate(resid1 = c(model1$residual),
         resid2 = c(model2$residual),
         resid3 = c(model3$residual)) 
fa_models

## pivot to long form
fa_models_long <- fa_models %>% 
  pivot_longer(cols = resid1:resid3, names_to = "model", values_to = "resid")
fa_models_long
```




